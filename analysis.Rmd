---
title: "Analysis for CogSci Expt"
author: "MH Tessler, Jason Madeano"
date: "6/7/2021"
output: pdf_document
---


# Helper Functions + Library Imports

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(brms)
library(tidybayes)
library(modelr)
library(lme4)
library(stringr)
library(tidyverse)
library(jsonlite)
library(viridis)
library(tidyboot)
library(knitr)
library(ggthemes)
library(ggstance)
library(tidytext)
library(jsonlite)
library(caret)
theme_set(theme_few())

parse_sum_scores <- function(x){
  sum(as.numeric(unlist(str_split(str_remove_all(x, "[Decimal'()\\[\\]]"), ","))), na.rm = T)
}

# path_to_repo_folder <- "~/Dropbox (MIT)/" # Replace with your absolute file path
path_to_repo_folder <- "~/projects/"
project.path <- paste(path_to_repo_folder, "growing_knowledge_culturally_neurips21/data/", sep = "")

```

```{r}
count_summary_fn <- function(x) x %>% 
  summarize(n = n()) %>%
  mutate(stat = n / sum(n))

mean_ci_funs <- list("ci_lower" = ci_lower, "mean" = mean, "ci_upper" = ci_upper)

#df.ugram %>%
  #group_by(generation) %>%
#  tidyboot(summary_function = count_summary_fn,
#        statistics_functions = function(x) x %>%
#        summarise(across(stat, mean_ci_funs, .names = "{.fn}")))

# parse_sum_scores <- function(x){
#   sum(as.numeric(unlist(str_split(str_remove_all(x, "[Decimal'()\\[\\]]"), ","))), na.rm = T)
# }
```


# Main Experiment

## Loading data
```{r}

failed_chains <- c("BkS2ANvld", "ByA9TVDed", "Hyd8aEwgd",
                    "rkQAqkUg_", "SkLyCEDl_", "SyZstewe_")


df_msg <- read_csv(paste(project.path, "messages.csv", sep = "")) %>%
          filter(!(chain %in% failed_chains))

df_survey <- read_csv(paste(project.path, "survey_responses.csv", sep = "")) %>%
  rowwise() %>%
  mutate(total_score = parse_sum_scores(game_scores)) %>%
  filter(!(chain %in% failed_chains))

df_game <- read_csv(paste(project.path, "experiments_no_states.csv", sep = "")) %>%
           filter(!(chain %in% failed_chains))

cbind(
  df_game %>% 
    dplyr::select(., -data),
  df_game %>%
    dplyr::pull(data) %>%
    purrr::map(., jsonlite::fromJSON) %>%
    dplyr::bind_rows()
) %>% 
  select(-desc_number) %>%
  rename(trial_num = game_number, life_num = round_number) %>%
  mutate_at(vars(steps, index), as.numeric) %>%
  left_join(., df_survey %>% select(chain, exp_id, generation)) -> df_game_tidy

```


## Survey responses

```{r}
df_survey %>%
  select(chain, exp_id, generation, enjoyment, total_score, fairprice, comments, problems, previous_experience) -> df_survey_select

df_survey_select[with(df_survey_select, order(chain, generation)), ] %>%
  rmarkdown::paged_table()
```


For new experiment data: sort by [exp_id, game_number, level_number, round_number, start_time, frame_number], in that order (round_number increments when a life is used — round starts at 1 and goes to 2 if the player skips/loses/dies)

Note: If a player refreshes while playing the game, they will be able to restart the level. So far, I don’t see this being a major problem, but we can look into it as we collect more data

## Sort data

```{r sort data}
df_game_tidy <- df_game_tidy[with(df_game_tidy, order(chain, generation, exp_id, trial_num, level_number, life_num, start_time, frame_number)), ]

df_game_tidy
```


Preprocessing note: If `game_order` is empty for a particular exp_id in survey_responses.csv , that participant did not complete the experiment so we probably want to remove any corresponding experiment or message data. 

Similarly, I implemented `dead_end` in order to give reasons for exclusion (‘returned’, ‘no message’, ‘mobile’, etc.).
Essentially, if `game_order` is null OR `dead_end` is not NA/null, we want to ignore their data


```{r filter data}
df_survey %>%
  filter(!is.na(game_order), is.na(dead_end), !is.na(chain)) -> df_survey_filtered

df_survey_filtered %>%
  filter(generation == 8) %>%
  pull(exp_id) -> ninth_gen_misfit


df_game_tidy_filtered <- left_join(
  df_survey_filtered %>% select(exp_id, chain, generation),
  df_game_tidy) %>%
  filter(!(exp_id %in% ninth_gen_misfit))

complete.exp_ids <- df_game_tidy_filtered%>% distinct(exp_id) %>% pull(exp_id)
length(complete.exp_ids)
```


### Previous game experience

Question was: "Have you ever played any of these games before? If so, how many?"

```{r}
df_survey_filtered %>%
  filter(!(exp_id %in% ninth_gen_misfit)) %>%
  mutate(no_exp = (
    str_detect(str_to_lower(previous_experience), "no") |
      previous_experience %in% c("0", "I haven't before", "I haven't played any of these games before.",
                                 "Never.", "I have never played any of these games.",
                                 "I have never played any of these games before.")
      
      )) %>%
  select(previous_experience, no_exp) %>%
  filter(!no_exp)
  # kable()
```


## Analysis


- steps, time per level = steps, time on multiple attempts (cumulative)
- score = score when "win" is reached

### Summarize attempts, levels, and games.

For each attempt at a level
- steps, time
- outcome
- possible score + bonus


```{r summarize attempts}
df_game_tidy_filtered %>%
  # left_join(., df_survey %>%
  #             select(chain, exp_id, generation)) %>%
  # ungroup() %>%
  group_by(exp_id, chain, generation, game_name, life_num,
           trial_num, level_number) %>%
  mutate(time_playing = time_playing / 1000) %>%
  summarize(
    steps_on_level_attempt = steps[which.max(steps)], 
    time_on_level_attempt = time_playing[which.max(time_playing)],
    win_outcome = win[which.max(time_playing)],
    score_attempt = score[which.max(time_playing)],
    bonus_attempt = game_end_time_bonus[which.max(time_playing)]
  ) -> df_game_tidy_filtered_attempts


df_game_tidy_filtered_attempts %>% 
  group_by(exp_id, chain, generation, game_name, trial_num, life_num) %>%
  summarize(
    max_level = max(level_number) + 1,
    total_time = sum(time_on_level_attempt) ,
    total_steps = sum(steps_on_level_attempt),
    time_per_attempt = mean(time_on_level_attempt),
    end_win = win_outcome[which.max(level_number)],
    levels_completed = ifelse(end_win == "win", max_level, max_level - 1)
  ) -> df_game_tidy_filtered_lives
```


For each level
- total steps, time (summing over attempts)
- final outcome
- actual score + bonus

```{r summarize levels}
df_game_tidy_filtered_attempts %>%
  ungroup() %>%
  group_by(exp_id, chain, generation, game_name,
           trial_num, level_number) %>%
  summarize(
    row_num = which.max(life_num),
    life_num = life_num[row_num],
    win = win_outcome[row_num],
    score = score_attempt[row_num],
    time_bonus = bonus_attempt[row_num],
    steps_on_level = sum(steps_on_level_attempt), 
    time_on_level = sum(time_on_level_attempt)
  ) -> df_game_level_summary

df_game_level_summary %>%
  filter(win == "win") -> df_game_level_wins_summary
```

For each game
- max level achieved / fraction of game complete
- total steps, time

```{r summarize games}
df_levig <- data.frame(
  game_name = c("avoid_george_v1", "explore_exploit_v1", "lemmings_var2_v1", 
                "plaqueattack_v1", "preconditions_v1", "push_boulders_v1", 
                "relational_v1", "sokoban_v1", "watergame_v1", "zelda_v1"),
  levels_in_game = c(5, 6, 5, 
                     5, 5, 4,
                     4, 5, 5, 5)
)

df_game_level_summary %>%
  group_by(exp_id, chain, generation, game_name) %>%
  summarize(
    max_level = max(level_number) + 1,
    total_time = sum(time_on_level) ,
    total_steps = sum(steps_on_level),
    time_per_level = mean(time_on_level),
    end_win = win[which.max(level_number)],
    levels_completed = ifelse(end_win == "win", max_level, max_level - 1)
  ) %>% 
  left_join(., df_levig) %>% mutate(
    fraction_levels_completed = levels_completed / levels_in_game
  ) -> df_game_summary
```

Filter data for only levels won
- # of levels won
- total steps, time

```{r summarize successes}
df_game_level_wins_summary %>%
  group_by(exp_id, chain, generation, game_name) %>%
  summarize(
    levels_won = max(level_number) + 1,
    total_time = sum(time_on_level) ,
    total_steps = sum(steps_on_level),
    time_per_level = mean(time_on_level),
    end_win = win[which.max(level_number)]
  ) %>% 
  left_join(., df_levig) %>% mutate(
    fraction_levels_completed = levels_won / levels_in_game
  ) -> df_game_wins_summary
```



### Levels won 

#### Fraction of levels completed by game

```{r}
df_game_summary %>%
  group_by(game_name) %>%
  tidyboot_mean(column = fraction_levels_completed, na.rm = T) -> df_game_frac_bs

df_game_frac_bs


coded_game_name = c("avoid_george_v1", "explore_exploit_v1", "lemmings_var2_v1", 
                "plaqueattack_v1", "preconditions_v1", "push_boulders_v1", 
                "relational_v1", "sokoban_v1", "watergame_v1", "zelda_v1")
full_game_name = c("AvoidGeorge", "ExploreExploit", 
                "Lemmings", "PlaqueAttack", "Preconditions", "PushBoulders",
                "Relational", "Sokoban", "Watergame", "Zelda")
  
  
df_game_frac_bs %>%
  mutate(game_name = factor(game_name, levels = coded_game_name, labels = full_game_name),
    game_name = reorder(game_name, mean)) %>%
  ggplot(., aes( x = game_name, y = mean, ymin = ci_lower, ymax = ci_upper))+
  geom_col(fill = 'white', color = 'black')+
  geom_jitter(data = df_game_summary %>%
                    mutate(game_name = factor(game_name, 
                                              levels = coded_game_name, 
                                              labels = full_game_name)), 
              inherit.aes = F,
              aes(x = game_name, y = fraction_levels_completed, color = game_name),
              alpha = 0.5)+
  geom_linerange(size = 1)+
  #scale_fill_viridis(discrete = T)+
  coord_flip()+
  guides(color = F)+
  labs(x = "Game", y = "Fraction of Game Completed")

# ggsave("figs/cogsciExpt_fracGameComplete_byGame.png", width = 5, height = 3.5)

```


#### FIGURE 3: Levels won by a player throughout 10 novel games vs. the generation in a chain

```{r}

count_summary_fn <- function(x) x %>% 
  summarize(stat = n())

mean_ci_funs <- list("ci_lower" = ci_lower, "mean" = mean, "ci_upper" = ci_upper)


df_game_level_summary %>%
  rowwise() %>%
  mutate(win_yes = win == "win") %>%
  filter(!is.na(win_yes)) %>%
  group_by(generation, chain, exp_id) %>%
  summarize(n = sum(win_yes)) -> df_gen_player_wins

df_gen_player_wins %>%
  group_by(generation) %>% 
  tidyboot_mean(column = n) -> df_gen_wins


df_gen_wins %>%
  ggplot(., aes(x = generation + 1, y = mean, ymin = ci_lower, ymax = ci_upper))+
  geom_linerange()+
  geom_line()+
  geom_line(data = df_gen_player_wins, inherit.aes = F,
            aes( x = generation + 1 , y = n, color = chain, group = chain), alpha = 0.3)+
  guides(color = F)+
  scale_x_continuous(limits =c(1,8), breaks = 1:8)+
  labs(x = "Generation", y = "Number of levels won by player")+
  ylim(0, 45)
  

# ggsave("figs/cogsciExpt_levelsWon_aggregate_n80.png", width = 4, height = 3)

```

```{r regression levels won aggregate}
lmer(
  data = df_gen_player_wins,
  formula = n ~ generation + (1 + generation | chain)
) -> lm.rs

summary(lm.rs)
```


#### Levels won, by chain / generation / game

```{r}
df_game_summary %>%
  #unite(exp_id, c(generation, exp_id)) %>%
  # filter(exp_id != "Bkz-wYj0D") %>%
  filter(game_name != "explore_exploit_v1") %>%
  ggplot(., aes( x = generation + 1, y = fraction_levels_completed, color = game_name))+
  #geom_col(color = 'black')+
  geom_line(size = 1.5)+
  geom_point(color = 'black', fill = 'black', shape = 15)+
  facet_grid(game_name~chain)+
  theme(
    # axis.text.x = element_text (angle = 45, hjust = 1, vjust = 1)
    #axis.text.x = element_blank(),
    strip.text.y = element_text(angle = 0),
    legend.position = 'bottom'#,
    #panel.grid.major.y = element_line(size = 0.1, linetype = 1)
    )+
  guides(color = F)+
  labs(
    x = "Generation", y = "Fraction of levels completed"
  )#+
   # scale_x_continuous(limits = c(0, 3), breaks = c(0, 1, 2, 3))

# ggsave("figs/cogsciExpt_fracLevel_byGameChain_n80.pdf", width = 10, height = 8)
```

## Ordinal regression


```{r}
df_game_summary %>%
  ungroup() %>%
  rowwise() %>%
  mutate(adjusted_level = (6 - levels_in_game) + levels_completed ) -> df_game_summary_adj

df_game_summary_adj %>%
  group_by(game_name, chain) %>%
  arrange(generation) %>%
  mutate(
    max_frac = cummax(fraction_levels_completed),
    max_adj_level = cummax(adjusted_level)
  ) -> df_game_summary_cummax
```


```{r}
brm(
 adjusted_level ~ generation +
  (1 + generation | chain) +
  (1 + generation | game_name),
   data = df_game_summary_adj %>%
   filter(game_name != "explore_exploit_v1"),
 family = cumulative("logit"),
 file = "brm_fit_ordinal_n80",
 # family = gaussian(),
 chains = 4,
 iter = 3000,
 cores = 4
) -> brm.fit


brm.fit

# brm(
#  fraction_levels_completed ~ generation +
#   (1 + generation | chain) +
#   (1 + generation | game_name),
#    data = df_game_summary_adj %>%
#    filter(game_name != "explore_exploit_v1"),
#  # family = cumulative("logit"),
#  file = "brm_fit_linear_n80",
#  family = gaussian(),
#  chains = 4,
#  iter = 3000,
#  cores = 4
# ) -> brm.fit.linear
# 
# brm.fit.linear

```


### FIGURE 4A: Learning across generations

```{r}
df_game_summary_adj %>%
  group_by(game_name, chain) %>%
  data_grid(generation = seq_range(generation, by = 1),
            chain = 'newchain') %>%
    add_draws(predict(brm.fit, newdata = ., summary = FALSE,
                    allow_new_levels = T)) -> brm_fitted_draws
  # add_draws(predict(brm.fit.linear, newdata = ., summary = FALSE,
  #                   allow_new_levels = T)) -> brm_fitted_draws


df_levig <- data.frame(
  game_name = c("avoid_george_v1", "explore_exploit_v1", "lemmings_var2_v1",
                "plaqueattack_v1", "preconditions_v1", "push_boulders_v1",
                "relational_v1", "sokoban_v1", "watergame_v1", "zelda_v1"),
  full_name = c("AvoidGeorge", "ExploreExploit",
                "Lemmings", "PlaqueAttack", "Preconditions", "PushBoulders",
                "Relational", "Sokoban", "Watergame", "Zelda"),
  levels_in_game = c(5, 6, 5,
                     5, 5, 4,
                     4, 5, 5, 5)
)

brm_fitted_draws %>%
  # rename(fraction_levels_completed = .value) %>%
  # mutate(generation = generation + 1)  -> brm_fitted_draws_adj
  left_join(., df_levig) %>% mutate(
    generation = generation + 1,
    levels_won = .value + levels_in_game - 6,
    fraction_levels_completed = levels_won / levels_in_game
  ) %>%
  filter(game_name != "explore_exploit_v1") -> brm_fitted_draws_adj

## Manually add jitter points

df_game_summary_adj %>%
  mutate(unique_id = paste(chain, game_name, generation, sep = ";")) -> df_game_summary_adj_uniqid


left_join(
  df_game_summary_adj_uniqid %>%
        mutate(group_id = paste(chain, game_name, sep = ";")),
  data.frame(
    unique_id = unique(df_game_summary_adj_uniqid$unique_id),
    jitterVal = runif(length(unique(df_game_summary_adj_uniqid$unique_id)),
                      min = -0.07, max = 0.07),
    jitterValy = runif(length(unique(df_game_summary_adj_uniqid$unique_id)),
                      min = -0.07, max = 0.07)
  )
  ) %>%
  mutate(
    jitterVal = jitterVal + generation + 1,
    fraction_levels_completed = fraction_levels_completed + jitterValy,
    generation = generation + 1
  ) %>%
  left_join(., df_levig) -> df_game_summary_adj_uniqid_jitter


### CODE RUNS UNTIL HERE^, CRASHES UPON RUNNING THE NEXT SEGMENT (sometimes?)

df_game_summary_adj_uniqid_jitter %>%
  filter(game_name != "explore_exploit_v1") %>%
  ggplot(., aes( x = generation, y = fraction_levels_completed, group = chain,
                 color = chain))+
  stat_lineribbon(data = brm_fitted_draws_adj,
                  aes(y = fraction_levels_completed), .width = c(.5),
                  geom = "lineribbon",
                  size = 1, linetype = 2, fill = 'grey', color = 'black',
                  alpha = 0.5)+
  # geom_line(
  #   size = 1, alpha = 0.6
  #   )+
  geom_point(
    aes(x = jitterVal,
        y = fraction_levels_completed,
         group = chain, color = chain),
    inherit.aes = F,
    # position = position_jitterdodge(jitter.height = 0.1,
    #                                 dodge.width = 0.2),
    alpha = 0.4#,
    #position = position_jitterdodge(jitter.height = 0.1), alpha = 0.4,
    #fill = 'black',
    # shape = 21,
  )+
  geom_line(aes(group = group_id),
    alpha = 0.3
  ) +
  stat_lineribbon(data = brm_fitted_draws_adj,
                  aes(y = fraction_levels_completed),
                  geom = "line",
                  size = 0.8, linetype = 1, color = 'black',
                  alpha = 1)+
             #position = position_dodge(dodge_width))+
  #scale_color_brewer(palette = "Greys") +
  #scale_fill_manual(values = alpha(c("grey"), 0.01))+
  #scale_color_viridis(discrete = T)+
  facet_wrap(~full_name, nrow = 3)+
  scale_y_continuous(#limits = c(-0.1, 1.25),
                     breaks = c(0, 0.2, 0.4, 0.6, 0.8, 1))+
  scale_x_continuous(breaks = 1:8)+
  theme(
    strip.text.y = element_text(angle = 0),
    legend.position = 'bottom'#,
    )+
  guides(color = F)+
  labs(
    x = "Generation", y = "Fraction of levels completed"
  )

# ggsave("figs/cogsciExpt_adjLevel_brm_n80_byGame.png", width = 7, height = 5)

```


## Game steps analysis

### Game steps summary per level of game

```{r}
df_game_level_summary %>%
  group_by(game_name, level_number) %>%
  tidyboot_mean(column = steps_on_level) -> df_game_steps_bs
  

```

### Game steps summary per win of level of game
```{r}
df_game_level_wins_summary %>%
  group_by(game_name, level_number) %>%
  tidyboot_mean(column = steps_on_level) -> df_game_wins_steps_bs
  
bar_width <- 0.8
df_game_wins_steps_bs %>%
  ggplot(., aes( x = game_name, fill = factor(level_number),
                 y = mean, ymin = ci_lower, ymax = ci_upper))+
  geom_col(width = bar_width, 
           position = position_dodge(bar_width), color = 'black')+
  geom_linerange(position = position_dodge(bar_width))+
  guides(fill = guide_legend(reverse = T, title = 'game level'))+
  labs( y = 'average number of steps', x = '')+
  coord_flip()
```

### FIGURE 5: Game steps summary per win of level of game by generation

All games.

```{r}
df_game_level_wins_summary %>%
  group_by(game_name, level_number, generation) %>%
  tidyboot_mean(column = steps_on_level) -> df_game_wins_gen_steps_bs
  
# bar_width <- 0.8
df_game_wins_gen_steps_bs %>%
  ungroup() %>%
  mutate(generation = factor(generation),
         level_number = factor(level_number)) %>%
  ggplot(., aes( x = generation, color = level_number,
                 y = mean, ymin = ci_lower, ymax = ci_upper, group = level_number))+
  geom_line()+
  facet_grid(level_number~game_name)+
  geom_linerange(alpha = 0.8)+
  guides(color = guide_legend(reverse = T, title = 'level_number'))+
  labs( y = 'average number of steps', x = 'generation')#+

# ggsave("figs/cogsciExpt_stepsPerWin_byGenbyGame.png", width = 25, height = 10)

```

Example games: Explore/Exploit and Relational

```{r}
df_game_wins_gen_steps_bs %>%
  filter(game_name %in% c("explore_exploit_v1", #"push_boulders_v1",
                          "relational_v1"),
         level_number < 4) %>%#, "preconditions_v1", "zelda_v1")) %>%
  ungroup() %>%
  mutate(generation = generation + 1,
         level_number = paste("Level ", level_number + 1, sep = ""),
         game_name = factor(game_name,
                            levels = c("explore_exploit_v1", #"push_boulders_v1",
                          "relational_v1"),
                          labels = c("ExploreExploit", "Relational"))) %>%
  ggplot(., aes( x = generation, color = level_number,
                 y = mean / 2, ymin = ci_lower /2, ymax = ci_upper/ 2, group = level_number))+
  geom_line(position = position_dodge(bar_width))+
  facet_grid(game_name~level_number)+
  geom_linerange(position = position_dodge(bar_width), alpha = 0.8)+
  scale_x_continuous(breaks = 1:8)+
  guides(color = F)+
  labs( y = 'Number of steps taken to win level', x = 'Generation')#+

# ggsave("figs/cogsciExpt_stepsByLevel_2games_n80.pdf", width = 5, height = 3)
```

# Control Data Analysis

## Losses and steps by game

```{r}
df.ind <- read_csv(paste(project.path, "control_first_level_losses.csv", sep = ""))

df.ind %>%
  pivot_longer(c(first_level_losses, 
               total_losses, first_level_steps, total_steps)) %>%
  group_by(game, name) %>%
  tidyboot_mean(column = value ) -> df_ind_summary
```

We only care about control games that match games from our experiment:

- explore_exploit
- preconditions
- plaqueattack
- sokoban
- avoid_george
- push_boulders
- relational
- watergame
- variant_lemmings_2
- zelda


```{r our games}
our_games <- c("ee", "avoidgeorge", "sokoban", "plaqueattack",
  "preconditions", "push_boulders", "relational", "watergame", 
  "lemminds_2", "zelda")


df_ind_summary %>%
  filter(game %in% our_games) %>%
  ggplot(., aes(x = game, y = mean, ymin = ci_lower, ymax = ci_upper))+
  geom_point()+
  geom_linerange()+
  facet_wrap(~name, scales = 'free') + 
  coord_flip()
```

## Full dataset

```{r}
df_pfull <- read_csv(paste(project.path, "control_full_human_data.csv", sep = "")) %>%
  mutate_at(vars(subject_ID, game_name, agent_type), as.factor)

summary(df_pfull)

df_pfull %>%
  group_by(subject_ID, game_name, level_number) %>%
  summarize(
    levels_won = max(cumulative_wins),
    total_steps = max(cumulative_steps)
    ) %>% 
  group_by(subject_ID, game_name) %>%
  mutate(
    steps_on_level = total_steps - lag(total_steps, default = 0)
  ) -> df_ind_steps_summary

```


### Filter/Exclude control data
```{r}
df_ind_steps_summary %>%
  filter(steps_on_level < 1000) %>%
  group_by(game_name, level_number) %>%
  tidyboot_mean(column = steps_on_level) -> df_ind_steps_bs

write_csv(df_ind_steps_bs, paste(project.path, "COMPUTED_control_data_steps_game_level_bs.csv", sep = ""))
```


## Learning efficiency

```{r}
df_ind_steps_summary %>%
  group_by(subject_ID, game_name) %>%
  summarize(
    learn_eff = max(levels_won) / max(total_steps)
  ) -> df_ind_summary

```

```{r}
df_ind_summary %>%
  filter(!is.na(learn_eff)) %>%
  filter(learn_eff > 0) %>%
  group_by(game_name) %>%
  tidyboot_mean(column = learn_eff) -> df_ind_eff_summary

write_csv(df_ind_eff_summary, paste(project.path, "COMPUTED_control_data_learnEff_bs.csv", sep = ""))

```

## Learning efficiency for 1st Two lives


```{r}
df_pfull %>%
  rowwise() %>%
  mutate(level_restarts_0 = level_restarts - 1) %>% #View()
  group_by(subject_ID, game_name, level_number) %>%
  summarize( max_restarts = max(level_restarts_0) )  %>% 
  arrange(subject_ID, game_name, level_number) %>% #View()
  mutate(c_restarts = cumsum(max_restarts),
         prev_restarts = lag(c_restarts, default = 0)) -> df_cumul_restarts

df_pfull %>%
  left_join(., df_cumul_restarts) %>% 
  mutate(
    level_restarts_0 = level_restarts - 1,
    curr_life_num = prev_restarts + level_restarts_0 + 1) %>%
  select(-X1, -agent_type, -levels_lost) -> df_pfull_currLife

df_pfull_currLife %>%
  filter(curr_life_num < 3) %>% 
  group_by(subject_ID, game_name) %>%
  summarize(
    n_wins = max(cumulative_wins),
    n_steps = max(cumulative_steps),
    learn_eff =  n_wins / n_steps
  ) -> df_ind_summary_2lives


```


```{r}
df_ind_summary_2lives %>%
  group_by(game_name) %>%
  tidyboot(column = n_wins, summary_function = median,
           statistics_functions = list(mean = mean, sd = sd)) -> df_ind_2lives_bs

```

## "Generation by generation"


```{r}
df_ind_summary_2lives %>%
  group_by(game_name) %>%
  tidyboot(column = n_wins, summary_function = median,
           statistics_functions = list("mean" = mean, "sd" = sd)) -> df_ind_2lives_bs

```

```{r}
df_pfull_currLife %>%
  ungroup() %>%
  filter(curr_life_num < 17) %>% 
  mutate(
    generation = floor((curr_life_num - 1) / 2)
  ) %>%
  group_by(subject_ID, game_name, generation) %>%
  summarize(
    n_wins = max(cumulative_wins),
    n_steps = max(cumulative_steps),
    learn_eff =  n_wins / n_steps
  ) -> df_ind_summary_gen


df_ind_summary_gen %>%
  unite(subj_game, c(subject_ID, game_name), sep = ";") %>%
  distinct(subj_game) %>%
  pull(subj_game) -> unique.subject.games

ci_lower_80 = function (x, na.rm = FALSE)  {
    unname(stats::quantile(x, 0.25, na.rm = na.rm))
}
ci_upper_80 = function (x, na.rm = FALSE) 
{
    unname(stats::quantile(x, 0.75, na.rm = na.rm))
}
mean_ci_funs <- list("ci_lower" = ci_lower_80, "mean" = mean, "ci_upper" = ci_upper_80)


expand.grid(
  subj_game = unique.subject.games,
  generation = unique(df_ind_summary_gen$generation)
) %>% 
  separate(subj_game, into = c("subject_ID", "game_name"), sep = ";") %>%
  left_join(df_ind_summary_gen) %>% 
  group_by(subject_ID, game_name) %>%
  mutate(n_wins= ifelse(is.na(n_wins), max(n_wins, na.rm = T), n_wins)) -> df_ind_expand_summary_gen
  
df_ind_expand_summary_gen %>%
  group_by(game_name, generation) %>%
  tidyboot(summary_function = function(x) x %>% summarise(median = median(n_wins)),
            statistics_functions = function(x) x %>% summarise(
              across(median, mean_ci_funs)
              )
           ) -> df_ind_gen_bs


df_ind_expand_summary_gen %>%
    ungroup() %>%
  mutate(game_name = factor(game_name,
                            levels = c("avoidgeorge", "ee", "lemmings_2", "plaqueattack", "preconditions", "push_boulders", 
                                       "relational","sokoban", "watergame", "zelda"),
                            labels = c("AvoidGeorge", "ExploreExploit", 
                "Lemmings", "PlaqueAttack", "Preconditions", "PushBoulders",
                "Relational", "Sokoban", "Watergame", "Zelda"))) %>%
  left_join(., data.frame(
      game_name = c("AvoidGeorge", "ExploreExploit", 
                "Lemmings", "PlaqueAttack", "Preconditions", "PushBoulders",
                "Relational", "Sokoban", "Watergame", "Zelda"),
  levels_in_game = c(5, 6, 5, 
                     5, 5, 4,
                     4, 5, 5, 5))) %>%
  mutate(frac_win = n_wins / levels_in_game
         ) -> df_ind_summary_gen_frac

df_ind_gen_bs %>%
  ungroup() %>%
  mutate(
    game_name = factor(game_name,
                            levels = c("avoidgeorge", "ee", "lemmings_2", "plaqueattack", "preconditions", "push_boulders", 
                                       "relational","sokoban", "watergame", "zelda"),
                            labels = c("AvoidGeorge", "ExploreExploit", 
                "Lemmings", "PlaqueAttack", "Preconditions", "PushBoulders",
                "Relational", "Sokoban", "Watergame", "Zelda"))) %>%
  left_join(., data.frame(
      game_name = c("AvoidGeorge", "ExploreExploit", 
                "Lemmings", "PlaqueAttack", "Preconditions", "PushBoulders",
                "Relational", "Sokoban", "Watergame", "Zelda"),
  levels_in_game = c(5, 6, 5, 
                     5, 5, 4,
                     4, 5, 5, 5))) %>%
  mutate(frac_median = empirical_median / levels_in_game,
         frac_median_lower = median_ci_lower / levels_in_game,
          frac_median_upper = median_ci_upper / levels_in_game
         ) %>%
  filter(game_name != "ExploreExploit") %>%
  ggplot(., aes( x = generation * 2, y = frac_median, group = game_name,
                 ymin = frac_median_lower, ymax = frac_median_upper))+
  geom_line(data = df_ind_summary_gen_frac %>% 
                filter(game_name != "ExploreExploit"), inherit.aes = F,
            aes(x = generation * 2, y = frac_win, color = subject_ID),
            alpha = 0.3
            )+
  geom_linerange(alpha = 1)+
  geom_line()+
  facet_wrap(~game_name, nrow = 3)+
  guides(fill = F, color = F)+
  labs(
    y = "Fraction of levels completed",
    x = 'Number of lives'
  )

ggsave("figs/individualLearners_levelsAchieved_generation.pdf", width = 7, height = 5)
```


## Ordinal Regression Modeling

### FIGURE 4B: Learning within individuals

```{r}

df_ind_expand_summary_gen %>%
  mutate(
    game_name = factor(game_name,
                            levels = c("avoidgeorge", "ee", "lemmings_2", "plaqueattack", "preconditions", "push_boulders",
                                       "relational","sokoban", "watergame", "zelda"),
                            labels = c("AvoidGeorge", "ExploreExploit",
                "Lemmings", "PlaqueAttack", "Preconditions", "PushBoulders",
                "Relational", "Sokoban", "Watergame", "Zelda"))) %>%
  left_join(., data.frame(
      game_name = c("AvoidGeorge", "ExploreExploit",
                "Lemmings", "PlaqueAttack", "Preconditions", "PushBoulders",
                "Relational", "Sokoban", "Watergame", "Zelda"),
  levels_in_game = c(5, 6, 5,
                     5, 5, 4,
                     4, 5, 5, 5))) %>%
  ungroup() %>%
  rowwise() %>%
  mutate(adjusted_level = (6 - levels_in_game) + n_wins,
         fraction_levels_completed = n_wins / levels_in_game) -> df_ind_expand_summary_gen_adj


write_csv(df_ind_expand_summary_gen_adj, paste(project.path, "COMPUTED_individualLearners_generationalFormat.csv", sep = ""))


brm(
 adjusted_level ~ generation +
  (1 + generation | subject_ID) +
  (1 + generation | game_name),
   data = df_ind_expand_summary_gen_adj %>%
   filter(game_name != "ExploreExploit"),
 family = cumulative("logit"),
 file = "brm_fit_ordinal_control",
 chains = 4,
 iter = 3000,
 cores = 4
) -> brm.fit.p

df_ind_expand_summary_gen_adj %>%
  group_by(game_name, subject_ID) %>%
  data_grid(generation = seq_range(generation, by = 1),
            subject_ID = 'newsubj') %>%
    add_draws(predict(brm.fit.p, newdata = ., summary = FALSE,
                    allow_new_levels = T)) -> brm_fitted_draws_indiv

brm_fitted_draws_indiv %>%
  left_join(., data.frame(
      game_name = c("AvoidGeorge", "ExploreExploit",
                "Lemmings", "PlaqueAttack", "Preconditions", "PushBoulders",
                "Relational", "Sokoban", "Watergame", "Zelda"),
  levels_in_game = c(5, 6, 5,
                     5, 5, 4,
                     4, 5, 5, 5))) %>% mutate(
    generation = generation + 1,
    n_lives = generation * 2,
    levels_won = .value + levels_in_game - 6,
    fraction_levels_completed = levels_won / levels_in_game
  ) %>%
  filter(game_name != "ExploreExploit") %>%
  mutate(fraction_levels_completed = ifelse(fraction_levels_completed < 0, 0, fraction_levels_completed))  -> brm_fitted_draws_adj_indiv

# manually add jitter points


df_ind_expand_summary_gen_adj %>%
  mutate(unique_id = paste(subject_ID, game_name, generation, sep = ";")) -> df_ind_expand_summary_gen_adj_uniqid


left_join(
  df_ind_expand_summary_gen_adj_uniqid %>%
        mutate(group_id = paste(subject_ID, game_name, sep = ";")),
  data.frame(
    unique_id = unique(df_ind_expand_summary_gen_adj_uniqid$unique_id),
    jitterVal = runif(length(unique(df_ind_expand_summary_gen_adj_uniqid$unique_id)),
                      min = -0.04, max = 0.04),
    jitterValy = runif(length(unique(df_ind_expand_summary_gen_adj_uniqid$unique_id)),
                      min = -0.04, max = 0.04)
  )
  ) %>%
  mutate(
    jitterLives = jitterVal + (generation + 1) * 2,
    jitterVal = jitterVal + generation + 1,
    fraction_levels_completed = fraction_levels_completed + jitterValy,
    generation = generation + 1
  ) %>%
  left_join(., data.frame(
      game_name = c("AvoidGeorge", "ExploreExploit",
                "Lemmings", "PlaqueAttack", "Preconditions", "PushBoulders",
                "Relational", "Sokoban", "Watergame", "Zelda"),
  levels_in_game = c(5, 6, 5,
                     5, 5, 4,
                     4, 5, 5, 5))) %>%
  filter(!is.na(fraction_levels_completed)) -> df_ind_expand_summary_gen_adj_uniqid_jitter


generational.markers = seq(0, 14, 2)

df_ind_expand_summary_gen_adj_uniqid_jitter %>%
  filter(game_name != "ExploreExploit") %>%
  mutate(n_lives = generation * 2) %>%
  ggplot(., aes( x = generation, y = fraction_levels_completed, group = subject_ID,
                 color = subject_ID))+
  stat_lineribbon(data = brm_fitted_draws_adj_indiv,
                  aes(y = fraction_levels_completed), .width = c(.5),
                  geom = "lineribbon",
                  size = 1, linetype = 2, fill = 'grey', color = 'black',
                  alpha = 0.3)+

  geom_point(
    aes(x = jitterVal,
        y = fraction_levels_completed,
         group = subject_ID, color = subject_ID),
    inherit.aes = F,
    alpha = 0.4
  )+
  geom_line(aes(group = group_id),
    alpha = 0.3
  ) +
  stat_lineribbon(data = brm_fitted_draws_adj_indiv,
                  aes(y = fraction_levels_completed),
                  geom = "line",
                  size = 0.8, linetype = 1, color = 'black',
                  alpha = 1)+
  facet_wrap(~game_name, nrow = 3)+
  scale_y_continuous(limits = c(-0.1, 1.1),
                     breaks = c(0, 0.25, 0.5, 0.75, 1))+
  scale_x_continuous(breaks = 1:8)+
  theme(
    strip.text.y = element_text(angle = 0),
    legend.position = 'bottom'#,
    )+
  guides(color = F)+
  labs(
    x = "'Generation'",
    y = "Fraction of levels completed"
  )

ggsave("figs/cogsciExpt_individuals_adjLevel_brm_byGame.pdf", width = 7, height = 5)
```


# Comparison to control data

## Load full control data

```{r}
df_ind_expand_summary_gen_adj <- read_csv(paste(project.path, "COMPUTED_individualLearners_generationalFormat.csv", sep = ""))
```

### Area under the learning curve for mean learner

```{r}
df_ind_expand_summary_gen_adj %>%
  group_by(generation, game_name) %>%
  summarize(
    mean_frac_completed = mean(fraction_levels_completed)
  ) -> df_ind_meanFrac_games

df_game_summary_cummax %>%
  mutate(game_name = factor(game_name,
                            levels = c("avoid_george_v1", "explore_exploit_v1", "lemmings_var2_v1", 
                "plaqueattack_v1", "preconditions_v1", "push_boulders_v1", 
                "relational_v1", "sokoban_v1", "watergame_v1", "zelda_v1"),
                labels =  c("AvoidGeorge", "ExploreExploit", 
                "Lemmings", "PlaqueAttack", "Preconditions", "PushBoulders",
                "Relational", "Sokoban", "Watergame", "Zelda"))) %>%
  group_by(generation, game_name) %>%
  summarize(
    mean_frac_completed = mean(fraction_levels_completed, na.rm = T), # generation by generation
  ) -> df_gen_meanFrac_games



bind_rows(
  df_ind_meanFrac_games %>%
    mutate(src = 'individual'),
  df_gen_meanFrac_games %>%
    mutate(src = 'chains')
) -> df_both_meanFrac_games
  
df_both_meanFrac_games %>%
  ggplot(., aes( x = generation, y = mean_frac_completed, color = src, group = src))+
  geom_line()+
  facet_wrap(~game_name, nrow = 2)

# ggsave("figs/curves_meanChain.png", width = 6.5, height = 4)
```


### FIGURE 6: AUC scatterplot on a participant-wise basis

```{r}

bind_rows(
  df_ind_expand_summary_gen_adj %>%
    group_by(subject_ID, game_name) %>%
    summarize(auc = bayestestR::area_under_curve(generation, fraction_levels_completed)) %>%
    ungroup() %>%
    select(game_name, auc) %>%
    mutate(src = 'individual'),
  df_game_summary_cummax %>%
    filter(!is.na(fraction_levels_completed)) %>%
    mutate(game_name = factor(game_name,
                              levels = c("avoid_george_v1", "explore_exploit_v1", "lemmings_var2_v1", 
                  "plaqueattack_v1", "preconditions_v1", "push_boulders_v1", 
                  "relational_v1", "sokoban_v1", "watergame_v1", "zelda_v1"),
                  labels =  c("AvoidGeorge", "ExploreExploit", 
                  "Lemmings", "PlaqueAttack", "Preconditions", "PushBoulders",
                  "Relational", "Sokoban", "Watergame", "Zelda"))) %>%
    group_by(chain, game_name) %>%
    summarize(auc = bayestestR::area_under_curve(generation, fraction_levels_completed)) %>%
    ungroup() %>%
    select(game_name, auc) %>%
    mutate(src = 'chains')
) %>%
  group_by(game_name, src) %>%
  tidyboot_mean(column = auc, na.rm = T) -> df_both_auc_bs

df_both_auc_bs %>%
  filter(game_name != "ExploreExploit") %>%
  pivot_wider(names_from = src, values_from = c(n, empirical_stat, ci_lower, ci_upper, mean),
              names_glue = "{src}_{.value}") -> df_both_auc_bs_wide


ggplot(df_both_auc_bs_wide, aes (x = individual_mean, y = chains_mean, label = game_name,
                 xmin = individual_ci_lower, xmax = individual_ci_upper,
                 ymin = chains_ci_lower, ymax = chains_ci_upper))+
  geom_abline(intercept = 0, slope = 1, lty = 2, alpha = 0.25)+
  geom_linerange(alpha = 0.4)+
  geom_linerangeh(alpha = 0.4)+
  geom_point(size = 2.5, color = '#43a2ca')+
  ggrepel::geom_text_repel(alpha = 0.7, box.padding = 1.25, force = 5, nudge_y = -1.25, segment.alpha = 0.25)+
  xlim(0.5, 7)+ylim(0.5, 7)+
  coord_fixed()+
  labs(
    x = "ALC for individuals",
    y = "ALC for chains"
  )

ggsave("figs/auc_scatter_bs.pdf", width = 5, height = 4)

```

```{r}
with(df_both_auc_bs_wide, cor(individual_mean, chains_mean))
```

# Exploratory Message Analysis

## Load data

```{r}
df_sent <- read_csv(paste(project.path, "ordered_message_history_by_sentence.csv", sep = "")) %>% 
  filter(exp_id %in% complete.exp_ids)

df_msg_editFine <- read_csv(paste(project.path, "messages_with_diff.csv", sep = "")) %>% 
  mutate(message_length = nchar(message)) %>%
  filter(exp_id %in% complete.exp_ids) %>%
  mutate(
    diff_add_count = ifelse(generation == 0, message_length, diff_add_count),
    diff_del_count = ifelse(generation == 0, 0, diff_del_count),
    edit_distance = ifelse(generation == 0, message_length, edit_distance)
  )

df_msg_orig <- df_msg %>%
  filter(exp_id %in% complete.exp_ids)
```

## Number of sentences by generation

```{r}
df_sent %>%
  group_by(chain, generation, game_name) %>%
  summarize(n_sentences = max(sentence_number) + 1) -> df_sent_chain_gen_game
```

bootstrap n_stencens by gen
```{r}

df_sent_chain_gen_game %>%
  group_by(generation, chain) %>%
  summarize(median = median(n_sentences)) -> df_sent_chain_gen

df_sent_chain_gen_game %>%
  group_by(generation, game_name) %>%
  summarize(median = median(n_sentences)) -> df_sent_game_gen


# mean_ci_funs <- list("ci_lower" = ci_lower_80, "mean" = mean, "ci_upper" = ci_upper_80)

df_sent_chain_gen_game %>%
  group_by(generation) %>%
  tidyboot(summary_function = 
             function(x) x %>% summarise(median = median(n_sentences)),
            statistics_functions = function(x) x %>% summarise(
              across(median, 
                     list("ci_lower" = ci_lower, "mean" = mean, "ci_upper" = ci_upper))
              )
           ) -> df_sent_gen_bs
```

```{r}

df_sent_gen_bs %>%
  filter(generation < 8) %>%
  ggplot(., aes(x = generation + 1, y = empirical_median, ymin = median_ci_lower, ymax = median_ci_upper))+
  geom_line(data = df_sent_game_gen, inherit.aes = F,
            aes(x = generation + 1, y = median, 
                color = game_name, group = game_name), alpha = 0.3)+
  geom_linerange( alpha = 0.7 )+
  geom_line()+
   scale_x_continuous(limits =c(1,8), breaks = 1:8)+
  labs(x = "Generation", y = "Median number of sentences")+
  scale_y_continuous(limits =c(0, 8), breaks = seq(0, 8, 2))
```


## Edit distance 

## Distribution by generation

```{r}
df_sent %>%
  mutate(edit_distance = ifelse(edit_distance == -1, 0, edit_distance)) %>%
  distinct(chain, generation, exp_id, game_name, message, edit_distance) -> df_msg_edit


df_msg_edit %>%  
  group_by(chain, generation) %>%
  summarize(mean_edit = mean(edit_distance)) -> df_edit_chain_gen


df_edit_chain_gen %>% 
  filter(generation != 0) %>%
  ggplot(., aes(x = mean_edit))+
  geom_histogram()
```


## Edit distance vs. levels won

```{r}
df_game_summary %>% 
  left_join(df_msg_editFine %>%
    distinct(chain, generation, exp_id, game_name, edit_distance, diff_add_count, diff_del_count)) %>%
  # left_join(df_msg_edit %>%
  #   distinct(chain, generation, exp_id, game_name, total_edit)) %>%
  filter(!is.na(fraction_levels_completed)) %>%
  # filter(generation != 0) %>%
  mutate(approx_frac = case_when(
    fraction_levels_completed == 0 ~ 0,
    fraction_levels_completed <= 0.25 ~ 0.25,
    fraction_levels_completed <= 0.5 ~ 0.5,
    fraction_levels_completed <= 0.75 ~ 0.75,
    fraction_levels_completed <= 1 ~ 1
  )) -> df_game_summary_edit

df_game_summary_edit %>%
  group_by(approx_frac) %>%
  tidyboot_mean(column = edit_distance, na.rm = T) -> df_game_edit_frac_bs
  #group_by()

df_game_edit_frac_bs %>%
  ggplot(., aes( x = approx_frac, y = mean, ymin = ci_lower, ymax = ci_upper))+
  geom_point(data = df_game_summary_edit,
             inherit.aes = F,
             aes( x = approx_frac, y = edit_distance, 
                  color = chain),
               position = position_jitter(width  = 0.05),
             alpha = 0.7)+
  geom_col( alpha = 0.4, color = 'black', width = 0.1)+
  geom_linerange(size = 1)+
  geom_path(alpha = 0.7)+
  guides(color = F)+
  scale_x_continuous(breaks = c(0, 0.25, 0.5, 0.75, 1))+
   scale_y_continuous(limits = c(0, 400))+
  ylab("Edit distance of message sent")+
  xlab("Fraction of levels completed by sender")

# ggsave("figs/cogsciExpt_editDistanceSender_levelCompleted_n80.pdf", width = 3.8, height = 3.6)
```


#### FIGURE 8: Amount of change to the message vs. success of the sender

```{r}
df_game_summary_edit %>%
  pivot_longer(names_to = "key", values_to = "val", 
               cols = c(edit_distance, diff_add_count,
                        diff_del_count)) %>%
  group_by(chain, generation, exp_id, key) %>%
  summarize(mean_val = mean(val),
            total_levels_won = sum(levels_completed) )  %>% 
  ungroup() %>%
  mutate(key = factor(key, levels = c( "diff_add_count", "diff_del_count", "edit_distance"),
                      labels = c(  "additions", "deletions", "total edits"))) -> df_chain_game_edit_levelswon
  #group_by()

df_chain_game_edit_levelswon %>%
  # mutate(generation = factor(generation + 1)) %>%
  mutate(generation = generation + 1) %>%
  ggplot(., aes( x = total_levels_won, y = mean_val, 
                 fill = generation))+
  scale_fill_viridis(discrete = F, breaks = 1:8)+
  geom_point(shape = 21)+
  geom_smooth(aes( x = total_levels_won, y = mean_val), inherit.aes = F,
              method = 'lm')+
  ylab('Average edits to message')+
  xlab("Number of levels won by participant")+
  facet_wrap(~key)+
  theme(legend.position = 'bottom')+
  guides(fill = guide_colourbar(nbin = 8))

# ggsave("figs/cogsciExpt_add_vs_deletions_byLevelsWon.pdf", 
#        width = 5, height = 3)

```

# What is in the language? (elicit classification)

## Unique Sentences
```{r}
# df_lng_labeled <- read_csv("data/ought-classification_labeled.csv")
# R is inferring the wrong type for some cols, so up the number of rows before inferring with guess_max (default 1000)
df_lng_unique <- read_csv("data/unique_sentences_tagged_9-15.csv", guess_max = 1500) %>% 
  filter(exp_id %in% complete.exp_ids,
         generation < 8) %>%
  rename(
    "dynamics_label" = "dynamics_human_label",
    "dynamics_elicit" = "dynamics_elicit_label",
    "dynamics_elicitProb" = "dynamics_elicit_confidence",
    "policy_label" = "policy_human_label",
    "policy_elicit" = "policy_elicit_label",
    "policy_elicitProb"= "policy_elicit_confidence",
    "abstractness_label" =  "abstract_human_label",
    "abstractness_elicit" = "abstract_elicit_label",
    "abstractness_elicitProb" = "abstract_elicit_confidence",
    "valence_label" = "valence_human_label",
    "valence_elicit" = "valence_elicit_label",
    "valence_elicitProb" = "valence_elicit_confidence",
    "dynamics_pastThreshold" = "dynamics_elicit_aboveThreshold",
    "policy_pastThreshold" = "policy_elicit_aboveThreshold",
    "abstractness_pastThreshold" = "abstract_elicit_aboveThreshold",
    "valence_pastThreshold" = "valence_elicit_aboveThreshold"
  ) %>%
  select(sentence, generation, game_name, chain, ends_with("_label"), ends_with("_elicit"),
         ends_with("_elicitProb"),
         ends_with("_pastThreshold"))
```

```{r}
df_lng_unique %>%
  pivot_longer(
    cols = c(-sentence, -generation, -game_name, -chain),
    names_to = c("tag", ".value"),
    names_pattern = "(.+)_(.+)"
  ) %>%
  mutate(elicit = 
           factor(elicit, 
                  levels = c(
                    "dynamics, or how the world works including explanations or affordances",
                    "not dynamics, or how the world works including explanations or affordances",
                    "policy, or what actions to take including strategies or instructions", 
                    "not policy, or what actions to take including strategies or instructions", 
                    "ignorance statements or specific experiences", 
                    "abstract, complex, high-level information", 
                    "concrete, simple, low-level information",
                    "neutral information", 
                    "losing, including information about death, losing points, lowering scores, forfeiting, losing lives, getting stuck or trapped", 
                    "winning, including mentions of scoring points, victory, success, goals, solutions, best strategies"), 
                  labels = c("dynamics", "NOTdynamics", "policy", "NOTpolicy", "ignorance", "abstract", "concrete", "neutral", "loss", "win"))) %>% 
  mutate(label = 
           factor(label, 
                  levels = c(
                    "dynamics, or how the world works including explanations or affordances",
                    "not dynamics, or how the world works including explanations or affordances",
                    "policy, or what actions to take including strategies or instructions", 
                    "not policy, or what actions to take including strategies or instructions", 
                    "ignorance statements or specific experiences", 
                    "abstract, complex, high-level information", 
                    "concrete, simple, low-level information",
                    "neutral information", 
                    "losing, including information about death, losing points, lowering scores, forfeiting, losing lives, getting stuck or trapped", 
                    "winning, including mentions of scoring points, victory, success, goals, solutions, best strategies"), 
                    labels = c("dynamics", "NOTdynamics", "policy", "NOTpolicy", "ignorance", "abstract", "concrete", "neutral", "loss", "win"))) -> df_lng_unique_tidy

df_lng_unique_summ <- df_lng_unique_tidy %>%
  select(-game_name, -chain, -elicitProb, pastThreshold) %>%
  group_by(generation, tag, elicit) %>%
 tidyboot(summary_function = count_summary_fn,
       statistics_functions = function(x) x %>%
       summarise(across(stat, mean_ci_funs, .names = "{.fn}")))
```


```{r}
ggplot(df_lng_unique_summ, aes(x = generation, 
                        y = mean, ymin = ci_lower, ymax = ci_upper, color = tag))+
  geom_linerange()+
  geom_line()+
  facet_wrap(~tag+ elicit)
```


## examine specific combinations of tags

```{r}
df_lng_unique %>%
  mutate(dynamics_elicit = 
           factor(dynamics_elicit, 
                  levels = c(
                    "dynamics, or how the world works including explanations or affordances",
                    "not dynamics, or how the world works including explanations or affordances"),
                  labels = c("dynamics", "not dynamics")),
         policy_elicit = 
           factor(policy_elicit, levels = c(                    "policy, or what actions to take including strategies or instructions", 
                    "not policy, or what actions to take including strategies or instructions"
           ), labels = c("policy", "not policy")
           ),
         abstractness_elicit = factor(abstractness_elicit, levels = c("ignorance statements or specific experiences", 
                    "abstract, complex, high-level information", 
                    "concrete, simple, low-level information"), labels = c("ignorance", "abstract", "concrete")),
         valence_elicit = factor(valence_elicit, levels = c("neutral information", 
                    "losing, including information about death, losing points, lowering scores, forfeiting, losing lives, getting stuck or trapped", 
                    "winning, including mentions of scoring points, victory, success, goals, solutions, best strategies"),
                    labels = c("neutral", "loss", "win"))) %>%
  mutate_at(vars(dynamics_elicit, policy_elicit, abstractness_elicit, valence_elicit), as.character) %>%
  unite("combined_tag", c(abstractness_elicit, dynamics_elicit, policy_elicit), sep = "_") %>%
  mutate(combined_tag = case_when(
    grepl("ignorance", combined_tag, fixed = TRUE) ~  "ignorance",
    combined_tag == "abstract_dynamics_policy" ~ "abstract_policy",
    combined_tag == "abstract_not dynamics_policy" ~ "abstract_policy",
    combined_tag == "concrete_dynamics_policy" ~ "concrete_policy",
    combined_tag == "concrete_not dynamics_policy" ~ "concrete_policy",
    TRUE ~ combined_tag)
    ) %>%
  filter(!grepl("not dynamics_not policy", combined_tag, fixed = TRUE)) -> df_lng_unique_combo
```

The above filtering / processing removes 'neither nor' statements and combines all forms of 'ignorance'. It also looks to see whether policy information is present (either with or without dynamics).


```{r}
df_lng_unique_combo_summ <- df_lng_unique_combo %>%
  group_by(generation, combined_tag) %>%
 tidyboot(summary_function = count_summary_fn,
       statistics_functions = function(x) x %>%
       summarise(across(stat, mean_ci_funs, .names = "{.fn}")))


ggplot(df_lng_unique_combo_summ, aes(x = generation, 
                        y = mean, ymin = ci_lower, ymax = ci_upper, color = combined_tag))+
  geom_linerange()+
  geom_line()+
  facet_wrap(~combined_tag)+
  guides(color = F)
```

```{r}
df_lng_unique_valence_summ <- df_lng_unique_combo %>%
  group_by(generation, valence_elicit) %>%
 tidyboot(summary_function = count_summary_fn,
       statistics_functions = function(x) x %>%
       summarise(across(stat, mean_ci_funs, .names = "{.fn}")))


ggplot(df_lng_unique_valence_summ, aes(x = generation, 
                        y = mean, ymin = ci_lower, ymax = ci_upper, color = valence_elicit))+
  geom_linerange()+
  geom_line()+
  facet_wrap(~valence_elicit)
```

## All Sentences
```{r}
# df_lng_labeled <- read_csv("data/ought-classification_labeled.csv")

df_lng_all <- read_csv("data/all_sentences_tagged_9-15.csv") %>% 
  filter(exp_id %in% complete.exp_ids,
         generation < 8) %>%
  rename(
    "dynamics_label" = "dynamics_human_label",
    "dynamics_elicit" = "dynamics_elicit_label",
    "dynamics_elicitProb" = "dynamics_elicit_confidence",
    "policy_label" = "policy_human_label",
    "policy_elicit" = "policy_elicit_label",
    "policy_elicitProb"= "policy_elicit_confidence",
    "abstractness_label" =  "abstract_human_label",
    "abstractness_elicit" = "abstract_elicit_label",
    "abstractness_elicitProb" = "abstract_elicit_confidence",
    "valence_label" = "valence_human_label",
    "valence_elicit" = "valence_elicit_label",
    "valence_elicitProb" = "valence_elicit_confidence",
    "dynamics_pastThreshold" = "dynamics_elicit_aboveThreshold",
    "policy_pastThreshold" = "policy_elicit_aboveThreshold",
    "abstractness_pastThreshold" = "abstract_elicit_aboveThreshold",
    "valence_pastThreshold" = "valence_elicit_aboveThreshold"
  ) %>%
  select(sentence, generation, game_name, chain, exp_id,
         # ends_with("_label"), 
         ends_with("_elicit"),
         ends_with("_elicitProb"),
         ends_with("_pastThreshold"))
```

```{r}
df_lng_all %>%
  pivot_longer(
    cols = c(-sentence, -generation, -game_name, -chain, -exp_id),
    names_to = c("tag", ".value"),
    names_pattern = "(.+)_(.+)"
  ) %>%
  mutate(elicit = 
           factor(elicit, 
                  levels = c(
                    "dynamics, or how the world works including explanations or affordances",
                    "not dynamics, or how the world works including explanations or affordances",          
                    "policy, or what actions to take including strategies or instructions", 
                    "not policy, or what actions to take including strategies or instructions", 
                    "ignorance statements or specific experiences", 
                    "abstract, complex, high-level information", 
                    "concrete, simple, low-level information",
                    "neutral information", 
                    "losing, including information about death, losing points, lowering scores, forfeiting, losing lives, getting stuck or trapped", 
                    "winning, including mentions of scoring points, victory, success, goals, solutions, best strategies"), 
                         labels = c("dynamics", "NOTdynamics", "policy", "NOTpolicy", "ignorance", "abstract", "concrete", "neutral", "loss", "win"))) -> df_lng_all_tidy

df_lng_all_summ <- df_lng_all_tidy %>%
  select(-game_name, -chain, -exp_id, -elicitProb, pastThreshold) %>%
  group_by(generation, tag, elicit) %>%
 tidyboot(summary_function = count_summary_fn,
       statistics_functions = function(x) x %>%
       summarise(across(stat, mean_ci_funs, .names = "{.fn}")))
```


```{r}
ggplot(df_lng_all_summ, aes(x = generation, 
                        y = mean, ymin = ci_lower, ymax = ci_upper, color = tag))+
  geom_linerange()+
  geom_line()+
  facet_wrap(~tag+ elicit)
```


## examine specific combinations of tags

```{r}
df_lng_all %>%
  mutate(dynamics_elicit = 
           factor(dynamics_elicit, 
                  levels = c(
                    "dynamics, or how the world works including explanations or affordances",
                    "not dynamics, or how the world works including explanations or affordances"),
                  labels = c("dynamics", "not dynamics")),
         policy_elicit = 
           factor(policy_elicit, levels = c(                    "policy, or what actions to take including strategies or instructions", 
                    "not policy, or what actions to take including strategies or instructions"
           ), labels = c("policy", "not policy")
           ),
         abstractness_elicit = factor(abstractness_elicit, levels = c("ignorance statements or specific experiences", 
                    "abstract, complex, high-level information", 
                    "concrete, simple, low-level information"), labels = c("ignorance", "abstract", "concrete")),
         valence_elicit = factor(valence_elicit, levels = c("neutral information", 
                    "losing, including information about death, losing points, lowering scores, forfeiting, losing lives, getting stuck or trapped", 
                    "winning, including mentions of scoring points, victory, success, goals, solutions, best strategies"),
                    labels = c("neutral", "loss", "win"))) %>%
  mutate_at(vars(dynamics_elicit, policy_elicit, abstractness_elicit, valence_elicit), as.character) %>%
  unite("combined_tag", c(abstractness_elicit, dynamics_elicit, policy_elicit), sep = "_") %>%
  mutate(combined_tag = case_when(
    grepl("ignorance", combined_tag, fixed = TRUE) ~  "ignorance",
    combined_tag == "abstract_dynamics_policy" ~ "abstract_policy",
    combined_tag == "abstract_not dynamics_policy" ~ "abstract_policy",
    combined_tag == "concrete_dynamics_policy" ~ "concrete_policy",
    combined_tag == "concrete_not dynamics_policy" ~ "concrete_policy",
    TRUE ~ combined_tag)
    ) %>%
  filter(!grepl("not dynamics_not policy", combined_tag, fixed = TRUE)) -> df_lng_all_combo
```

The above filtering / processing removes 'neither nor' statements and combines all forms of 'ignorance'. It also looks to see whether policy information is present (either with or without dynamics).


```{r}
df_lng_all_combo_summ <- df_lng_all_combo %>%
group_by(generation, combined_tag) %>%
 tidyboot(summary_function = count_summary_fn,
       statistics_functions = function(x) x %>%
       summarise(across(stat, mean_ci_funs, .names = "{.fn}")))


ggplot(df_lng_all_combo_summ, aes(x = generation, 
                        y = mean, ymin = ci_lower, ymax = ci_upper, color = combined_tag))+
  geom_linerange()+
  geom_line()+
  facet_wrap(~combined_tag)+
  guides(color = F)
```

```{r}
df_lng_all_valence_summ <- df_lng_all_combo %>%
  group_by(generation, valence_elicit) %>%
 tidyboot(summary_function = count_summary_fn,
       statistics_functions = function(x) x %>%
       summarise(across(stat, mean_ci_funs, .names = "{.fn}")))


ggplot(df_lng_all_valence_summ, aes(x = generation, 
                        y = mean, ymin = ci_lower, ymax = ci_upper, color = valence_elicit))+
  geom_linerange()+
  geom_line()+
  facet_wrap(~valence_elicit)
```

## Relating language to performance / play

```{r}
# df_lng_all_tidy %>%
df_lng_all_combo %>%
  # mutate(elicit = as.character(elicit)) %>%
  # group_by(chain, generation, game_name, exp_id, tag, elicit) %>%
  group_by(chain, generation, game_name, exp_id, combined_tag) %>%
  count() %>%
  ungroup() %>%
  group_by(chain, generation, game_name, exp_id) %>%
  mutate(
    prop = n / sum(n)
  ) %>% 
  # select(-n) %>%
  select(-prop) %>%
  pivot_wider(names_from = combined_tag, 
#              values_from = prop,
              values_from = n,
              values_fill = 0) -> df_lng_all_tidy_prop

df_lng_all_tidy_prop %>% 
  pivot_longer(cols = c(-chain, -generation, -game_name, -exp_id),
               names_to = "combined_tag",
               values_to = "prop") %>%
  ggplot(., aes(x = prop))+
  geom_histogram()
```
 
```{r check size of msg tag df}
# worked with older version of df_lng_all_tidy_prop that depended on df_lng_all_tidy 

# df_lng_all_tidy_prop %>%
#   unite("tag_elicit", c(tag, elicit)) %>%
#   select(-n) %>%
#   spread(tag_elicit, prop) %>%
#   glimpse()
```

### join msg stats with performance stats

```{r}
df_lng_all_tidy_prop %>%
  left_join(., 
            df_msg_editFine %>% 
              ungroup() %>% 
              select(exp_id, received_from_id) %>%
              rename(receiver_id = exp_id,
                     exp_id = received_from_id)) %>%
  rename(sender_id = exp_id) %>% 
  rename(exp_id = receiver_id) %>%
  ungroup() %>%
  select(-generation) %>%
  left_join(., df_game_summary) %>%
  left_join(df_msg_editFine %>% 
              ungroup() %>% 
              rename(sender_id = exp_id) %>% 
              select(sender_id, game_name, message_length)) %>% 
  distinct() -> df_game_lng


df_game_lng %>%
  mutate(
    concrete_policy_norm = concrete_policy - mean(concrete_policy),
    `concrete_dynamics_not policy_norm` = `concrete_dynamics_not policy` - mean(`concrete_dynamics_not policy`),
    `abstract_dynamics_not policy_norm` = `abstract_dynamics_not policy` - mean(`abstract_dynamics_not policy`),
    abstract_policy_norm = abstract_policy - mean(abstract_policy),
    ignorance_norm = ignorance - mean(ignorance)
  ) -> df_game_lng_norm
```

basic thing

```{r}
lm(
  fraction_levels_completed ~ -1 + abstract_policy + ignorance + 
    `concrete_dynamics_not policy` + `abstract_dynamics_not policy` +
    concrete_policy + message_length, 
  data = df_game_lng %>%
    filter(!is.na(fraction_levels_completed))
  ) -> rs.prelim.lang

summary(rs.prelim.lang)
```

```{r}
df_game_lng %>%
    select(chain, game_name, fraction_levels_completed, 
           abstract_policy, ignorance, generation,
    `concrete_dynamics_not policy`, `abstract_dynamics_not policy`,
    concrete_policy)  %>%
  #distinct()
  pivot_longer(cols = c(-chain, -generation, -game_name, -fraction_levels_completed),
               names_to = "combined_tag",
               values_to = "prop") -> df_game_lng_long

df_game_lng_long %>%
  ggplot(., aes( x = prop, y = fraction_levels_completed))+
  geom_point()+
  facet_wrap(~combined_tag)

```




normed predictors
```{r}
lm(
  fraction_levels_completed ~ -1 + abstract_policy_norm + ignorance_norm + 
    `concrete_dynamics_not policy_norm` + `abstract_dynamics_not policy_norm` +
    concrete_policy_norm, 
  data = df_game_lng_norm %>%
    filter(!is.na(fraction_levels_completed))
  ) -> rs.prelim.lang_norm

summary(rs.prelim.lang_norm)
```


```{r}
df_game_lng %>%
  ungroup () %>%
  select(abstract_policy, ignorance,
    `concrete_dynamics_not policy`, `abstract_dynamics_not policy`,
    concrete_policy) %>%
  View()

```
# What sentences are deleted?
```{r}
df_lng_all
```

# Elicit accuracy

## Overall

```{r}
df_lng_unique_tidy %>% 
  filter(!is.na(label)) -> df_lng_unique_tidy_labeled

confusionMatrix(data = df_lng_unique_tidy_labeled$elicit, 
                reference = df_lng_unique_tidy_labeled$label,
                mode = "prec_recall")
```

## Dynamics

```{r}
df_lng_unique_tidy_labeled %>% filter(tag == "dynamics") %>% droplevels(.) -> df_lng_unique_tidy_labeled_dynamics

confusionMatrix(data = df_lng_unique_tidy_labeled_dynamics$elicit, 
                reference = df_lng_unique_tidy_labeled_dynamics$label,
                mode = "prec_recall")
```

## Policy

```{r}
df_lng_unique_tidy_labeled %>% filter(tag == "policy") %>% droplevels(.) -> df_lng_unique_tidy_labeled_policy

confusionMatrix(data = df_lng_unique_tidy_labeled_policy$elicit, 
                reference = df_lng_unique_tidy_labeled_policy$label,
                mode = "prec_recall")
```

## Abstractness

```{r}
df_lng_unique_tidy_labeled %>% filter(tag == "abstractness") %>% droplevels(.) -> df_lng_unique_tidy_labeled_abstractness

confusionMatrix(data = df_lng_unique_tidy_labeled_abstractness$elicit, 
                reference = df_lng_unique_tidy_labeled_abstractness$label,
                mode = "prec_recall")

```

## Valence

```{r}
df_lng_unique_tidy_labeled %>% filter(tag == "valence") %>% droplevels(.) -> df_lng_unique_tidy_labeled_valence

confusionMatrix(data = df_lng_unique_tidy_labeled_valence$elicit, 
                reference = df_lng_unique_tidy_labeled_valence$label,
                mode = "prec_recall")
```